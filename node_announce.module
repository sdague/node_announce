<?php
/**
 * @file
 *
 * This module allows admins to set recurrent announcements for nodes to send
 * to specified email addresses.
 */

/**
 * Implementation of hook_help()
 */
function node_announce_help($path, $arg) {
  $output = '';
  switch($path) {
    case 'admin/help#node_announce':
      $output =
        '<h2>' . t('About') . '</h2>' .
        t('Node Announce is designed to solve a problem I had. Most of my
community drupal sites are basically event listings. Clubs that have
one or two events going on every month. These organizations also have
discussion lists that are on some other site (yahoo, or a straight
mailman list). What I wanted was a way to automatically and regularly
sent out announcements for the events on our site.') .
        '<p>' .
        t('Thus became Node Announce.').
        '<h3>'. t('Usage') . '</h3>'.
        t('Once you have installed Node Announce you will need to create a <a href="admin/config/system/node_announce/add">new
announcement</a>.').
        '<p>'.
        t('You will then be creating an announcement for a Content Type, based on
a specific Date field that it has. The days before field is used to
send out the email announce aproximately that many days before (as set
by the user). This is aproximately as it runs as a drupal cron
task. Because of possible timing issues Node Announce will actually
send out an email sometime within the timeblock that is 24 hours
before and 24 hours prior to the ideal date/time.').
        '<p>'.
        t('Drupal Cron <b>must</b> be run at least daily for Node Announce to be reliable.').
        '<p>'.
        t('The announcement contains the from and to email address, as well as
subject and message fields that are tokenized. You can use any of the
standard tokens in either the subject or body.')
        ;
      break;
  }
  return $output;
}

/**
 * Implementation of hook_menu()
 */
function node_announce_menu() {
  $items = array();
  $items['admin/config/system/node_announce'] = array(
    'title' => 'Node Announcements',
    'description' => 'Configure node announcements',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('node_announce_form_list'),
    'access arguments' => array('administer node announcements'),
    'file' => 'node_announce.admin.inc',
  );

  $items['admin/config/system/node_announce/list'] = array(
    'title' => 'List',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -1,
  );

  $items['admin/config/system/node_announce/add'] = array(
    'title' => 'Add Announcement',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('node_announce_form'),
    'access arguments' => array('administer node announcements'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'node_announce.admin.inc',
  );


  $items['admin/config/system/node_announce/%/edit'] = array(
    'type' => MENU_LOCAL_TASK,
    'title' => 'Edit',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('node_announce_form', 4),
    'access arguments' => array('administer node announcements'),
    'file' => 'node_announce.admin.inc',
  );

  $items['admin/config/system/node_announce/%/log'] = array(
    'type' => MENU_LOCAL_TASK,
    'title' => 'Log',
    'page callback' => 'node_announce_view_log',
    'page arguments' => array(4),
    'access arguments' => array('administer node announcements'),
    'file' => 'node_announce.admin.inc',
  );

  $items['admin/config/system/node_announce/%'] = array(
    'title' => 'Preview Announcement',
    'page callback' => 'node_announce_preview',
    'page arguments' => array(4),
    'access arguments' => array('administer node announcements'),
    'file' => 'node_announce.admin.inc',
  );

  $items['admin/config/system/node_announce/%/preview'] = array(
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'title' => 'Preview',
    'page callback' => 'node_announce_preview',
    'page arguments' => array(4),
    'access arguments' => array('administer node announcements'),
    'file' => 'node_announce.admin.inc',
    'weight' => -1
  );

  $items['admin/config/system/node_announce/%/send'] = array(
    'type' => MENU_LOCAL_TASK,
    'title' => 'Send',
    'page callback' => 'node_announce_send',
    'page arguments' => array(4),
    'access arguments' => array('administer node announcements'),
    'file' => 'node_announce.admin.inc',
  );


  return $items;
}


function node_announce_init() {
  drupal_add_css(drupal_get_path('module', 'node_announce') .'/css/node_announce.css');
}

/**
 * Implementation of hook_permission()
 */
function node_announce_permission() {
  return array('administer node announcements' => array(
      'title' => t('Administer Node Announcements'),
      'description' => t('Create / Edit / Remove Node Announcements.')
    )
  );
}

/**
 * Implementation of hook_nodeapi()
 */
function node_announce_node_delete($node) {
  node_announce_delete_records_by_nid($node->nid);
}

/**
 *  Implementation of hook_cron().
 *
 *  Go through all the announcements and set
 */
function node_announce_cron() {
  node_announce_process_announces();
}

function node_announce_theme() {
  $base = array(
    'path' => drupal_get_path('module', 'node_announce') . "/theme"
  );

  // TODO: get forms in here as well, though I was having an issue getting
  // them to take parameters as well as the form parameters
  $themes = array(
    'node_announce_list' => $base + array(
      'template' => 'node-announce-list',
      'variables' => array('announces' => array())
    ),
    'node_announce_preview' => $base + array(
      'template' => 'node-announce-preview',
      'variables' => array('announce' => NULL, 'node' => NULL)
    ),
    'node_announce_view_log' => $base + array(
      'template' => 'node-announce-view-log',
      'variables' => array('announce' => NULL, 'records' => array())
    ),
  );
  return $themes;
}



/***
 *
 */

function node_announce_process_announces() {
  // drupal_set_message("Running node_announce cron job");
  $announces = node_announce_list();

  // drupal_set_message("Got the following announces: " . print_r($announces, TRUE));

  foreach ($announces as $ann) {
    $nodes = node_announce_applicable_nodes($ann);

    // drupal_set_message("Announce " . $ann->id . " got the following nodes: " . print_r($nodes, TRUE));

    foreach ($nodes as $node) {
      if (! node_announce_already_announced($ann, $node)) {
        node_announce_send_announce($ann, $node);
        node_announce_record_send($ann->id, $node->nid);
      }
    }
  }
}

/***
 * node_announce_send_announce : send email announcement out
 *
 * We prefer mimemail if that exists, but will also use the basic drupal mail
 * infrastructure as a fall back.
 */

function node_announce_send_announce($ann, $node) {
  $params = array('announce' => $ann, 'node' => $node);
  $token = ($ann->email_token) ? $ann->email_token : "node_announce";
  $result = drupal_mail('node_announce', $token, $ann->email_to, language_default(), $params);
}

/**
 * node_announce_mail : implementation of hook_mail()
 *
 * This is only called if mimemail isn't installed
 */

function node_announce_mail($key, &$message, $params) {
  $node = $params['node'];
  $ann = $params['announce'];

  $to = token_replace($ann->email_to, array('node' => $node));
  $from = token_replace($ann->email_from, array('node' => $node));
  // TODO: we should validate to and from here

  $message['to'] = $to;
  $message['from'] = $from;
  # yes, this is stupid, but it's the only way to get from set correctly
  $message['headers']['From'] = $from;
  $message['headers']['Sender'] = $from;
  $message['headers']['Return-Path'] = $from;

  $message['subject'] = drupal_html_to_text(
    token_replace($ann->subject, array('node' => $node)));

  # this is not quite enough to make node_announce use html mail
  # you also need to set the mail system
  $message['body'][] = token_replace(
    $ann->message, array('node' => $node));
}

function node_announce_title_edit($id) {
  _node_announce_load_api();
  $ann = node_announce_load($id);
  return 'Edit Node Announce: ' . $ann->name;
}

/*** API ***/

/**
 * @file Database API for node_announce
 *
 */

/**
 * Function to load a node_announce by id
 * @param
 *  id
 */

function node_announce_load($id) {
  if ($id) {
    return db_select('node_announce', 'na')
      ->fields('na')
      ->condition('id', $id, '=')
      ->execute()
      ->fetchObject();
  } else {
    return NULL;
  }
}


function node_announce_list() {
  $results = array();
  $r = db_select('node_announce', 'na')
    ->fields('na')
    ->orderBy('date_field')
    ->orderBy('days_before')
    ->execute();

  foreach ($r as $obj) {
    $results[] = $obj;
  }

  return $results;
}

/**
 * Function to save a node announce, could be new or old
 *
 */
function node_announce_save(&$announce) {
  $announce_current = node_announce_load($announce->id);
  if ($announce_current) {
    return drupal_write_record('node_announce', $announce, 'id');
  } else {
    return drupal_write_record('node_announce', $announce);
  }
}

function node_announce_delete_records_by_nid($nid) {
  db_delete('node_announce_records')
    ->condition('nid', $nid)
    ->execute();
}

function node_announce_delete_records_by_aid($aid) {
  db_delete('node_announce_records')
    ->condition('aid', $aid)
    ->execute();
}

function node_announce_delete($aid) {
  node_announce_delete_records_by_aid($aid);
  db_delete('node_announce')
    ->condition('id', $aid)
    ->execute();
}

/**
 * This returns a list of date field options
 */

function node_announce_date_field_options() {
  $fields = array();

  $query = db_select('node_type', 'n');
  $query->join('field_config_instance', 'fci', 'fci.bundle=n.type');
  $query->join('field_config', 'fc', 'fci.field_id=fc.id');

  $results = $query->fields('n', array('name', 'type'))
    ->fields('fc', array('field_name'))
    ->fields('fci', array('data'))
    ->condition('fc.module', 'date')
    ->execute();

  // TODO: get the field label out of the fci.data
  foreach ($results as $obj) {
    $fields[$obj->type . ":" . $obj->field_name] = $obj->name . " - " . $obj->field_name;
  }
  return $fields;
}

/**
 * Pretty name for date field
 */
function node_announce_date_field_pretty($field) {
  $fields = node_announce_date_field_options();
  return $fields[$field];
}


/**
 *
 */
function node_announce_next_match($ann, $before=FALSE) {
  $array = explode(":", $ann->date_field);
  $type = $array[0];
  $field = $array[1];
  $fv = $field . "_value";

  // TODO: this is inefficient, but I can't figure out how to get a litteral
  // NOW() down to the database. So select it, use it, and move on
  $q = db_select('node', 'n');
  $q->addExpression('NOW()', 'now');
  $n = $q->execute()->fetchObject();

  $query = db_select('field_data_' . $field, 'f');
  $query->join('node', 'n', 'n.nid = f.entity_id');
  $query->fields('n', array('nid'))
    ->condition('n.type', $type);

  if (!$before) {
    $query->condition('f.' . $fv, $n->now, '>');
    $query->orderBy('f.' . $fv, 'ASC');
  } else {
    $query->condition('f.' . $fv, $n->now, '<');
    $query->orderBy('f.' . $fv, 'DESC');
  }
  $query->range(0, 1);
  $obj = $query->execute()->fetchObject();
  if (!$obj) {
    return NULL;
  }
  $node = node_load($obj->nid);
  return $node;
}

/**
 *
 *  For a given announce, figure out which nodes are in the time window. This requires selecting by node type
 */

function node_announce_applicable_nodes($ann) {
  $array = explode(":", $ann->date_field);
  $type = $array[0];
  $field = $array[1];
  $fv = $field . "_value";
  $nodes = array();

  $before = strftime("%Y-%m-%d %H:%M", time() + 24*60*60 * ($ann->days_before - 1));
  $after = strftime("%Y-%m-%d %H:%M", time() + 24*60*60 * ($ann->days_before + 1));

  $query = db_select('field_data_' . $field, 'f');
  $query->join('node', 'n', 'n.nid = f.entity_id');
  $query->fields('n', array('nid'));
  $query->condition('n.type', $type);
  $query->condition('f.' . $fv, $before, '>');
  $query->condition('f.' . $fv, $after, '<');
  $result = $query->execute();

  foreach ($result as $obj) {
    $node = node_load($obj->nid);
    $nodes[] = $node;
  }
  return $nodes;
}

/**
 * TODO: Repeating events are going to need more work
 */

function node_announce_already_announced($ann, $node) {
  $obj = db_select("node_announce_records", "n")
    ->fields('n', array('last_sent'))
    ->condition("nid", $node->nid)
    ->condition("aid", $ann->id)
    ->execute()
    ->fetchObject();

  if ($obj) {
    return $obj->last_sent;
  } else {
    return NULL;
  }
}

function node_announce_load_records($aid) {
  $result = db_select("node_announce_records", "n")
    ->fields('n')
    ->condition('aid', $aid)
    ->orderBy('last_sent', 'DESC')
    ->execute();

  $records = array();
  foreach ($result as $record) {
    $record->node = node_load($record->nid);
    $record->url = url(drupal_get_path_alias('node/' . $record->nid), array('absolute' => TRUE));
    $record->when = format_date($record->last_sent);
    $records[] = $record;
  }
  return $records;
}

function node_announce_record_send($aid, $nid) {
  $obj = (object)array(
                       "nid" => $nid,
                       "aid" => $aid,
                       "last_sent" => time()
                       );
  drupal_write_record('node_announce_records', $obj);
}